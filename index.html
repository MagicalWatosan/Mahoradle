<!DOCTYPE html><html><head><meta name="author"content="@MagicalWatosan"><title>Mahoradle</title><link rel="stylesheet"href="stylesheet.css"/></head><body oncontextmenu="return false;"><table id="words"><colgroup id="tableCols"></colgroup></table><table border=0><tr><td colspan=3><form action=""onsubmit="return determine();"><input type="text"id="inputBox"><input type="submit"id="determineButton"value="決定"></form><tr><td><input type="button"id="button_reset"value="リセット"onclick="initialize(true);"><label id="label_button_reset"for="button_reset">リセット</label><td><div class="toggle_button"><input type='checkbox'id="rnd_choice"class="toggle_input"onclick="onclick_rnd_choice()"/><label for="rnd_choice"class="toggle_label"></label></div><td><span id="rndtxt"style="font-size: 13px; color:#999999">ランダム選択</span><tr><td><input type="button"id="button_hint"value="ヒント"onclick="nextHint()"/><tr><td colspan=3><div id="hintBox"></div><tr><td><input type="button"id="button_custom"value="カスタム作成"onclick="creatorDialog.showModal();"/></table><!-- --------------------------------------------------------------------------------------------------------------- --><dialog id="creatorDialog"><input type="button"value="×"onclick="creatorDialog.close();"><div id="create_error"></div><table id="table_range"><col class="col1"><col class="col2"><col class="col3"><tr><td colspan=2>スプレッドシートID,シート名!範囲<td align="right"><input type="button"id="checkButton"value="読取チェック"onclick="setCreateParams(this);"><tr><td colspan=3><textarea id="input_range"class="txt"rows=5 wrap="off"oninput="setCreateParams(this);"></textarea></table><table><tr><td>正解：<input type="text"value=""id="input_correctAnswer"onchange="setCreateParams(this);"disabled>ランダム：<span class="toggle_button"><input type='checkbox'id="create_random"class="toggle_input"onchange="setCreateParams(this);"checked/><label for="create_random"class="toggle_label"></label></span><tr><td>読込最小文字数：<input type="text"value=2 id="limit_word_minLength"onchange="setCreateParams(this);"><tr><td>読込最大文字数：<input type="text"value=100 id="limit_word_maxLength"onchange="setCreateParams(this);"><tr><td>回答最小文字数：<input type="text"value=4 id="limit_answer_minLength"onchange="setCreateParams(this);"><tr><td>回答最大文字数：<input type="text"value=100 id="limit_answer_maxLength"onchange="setCreateParams(this);"><tr><td>正解最小文字数：<input type="text"value=4 id="limit_correctAnswer_minLength"onchange="setCreateParams(this);"><tr><td>正解最大文字数：<input type="text"value=100 id="limit_correctAnswer_maxLength"onchange="setCreateParams(this);"><tr><td><select id="kanji_level"onchange="setCreateParams(this);"><option value=0>漢字を含まない</option><option value=1 selected>漢字のみの言葉は含まない</option><option value=2>漢字のみの言葉も含む</option></select></table><input type="button"id="button_createUrl"value="URL作成"onclick="setCreateParams(this);"disabled><a id="box_url"target="_blank">---</a></dialog><!-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ --><script type="text/javascript">const wordMap=new Map();const simpleWordSet=new Set();let correctAnswer="";let tableWidth=1;const hintObj=[];const cellList=[];const defaultParams={resource:[{sheetId:"1msKsJutQIyiKl9ZSSuGaN6uAwVegy1sIHK4_wu82Y_M",ranges:['名簿!B1:T','コンテンツ1!A1:','コンテンツ2!B1:C']}],limit_word_minLength:2,limit_word_maxLength:100,limit_answer_minLength:4,limit_answer_maxLength:100,limit_correctAnswer_minLength:4,limit_correctAnswer_maxLength:100,kanji_level:1,random_choice:false,correctAnswer:undefined,};input_range.value="1msKsJutQIyiKl9ZSSuGaN6uAwVegy1sIHK4_wu82Y_M, 名簿!B1:T，コンテンツ1!A1:，コンテンツ2!B1:C\n"const aKey="AIzaSyDMcsEVZHO0hO5ivJFDj0UjfSwoN9QTPvo";const params=(()=>{try{const p=JSON.parse(decodeURI(location.search).slice(1));if(p.correctAnswer){const d0=p.correctAnswer.split("").map((v,i)=>i%2==1?"":v).join("");const decoded=atob(d0);p.correctAnswer=fromBinary(decoded)}for(let key in defaultParams){if(p[key]==undefined){p[key]=defaultParams[key]}}localStorage.setItem("params",JSON.stringify(p));return p}catch(e){const p=JSON.parse(localStorage.getItem("params"));if(p){return p}else{console.log("read default resource");return defaultParams}}})();const history=(()=>{const h=JSON.parse(localStorage.getItem("history"));return h?h:[]})();startup();console.log(params)const createParams={};setCreateParams({});async function setCreateParams(obj){if(obj.id=="button_createUrl"){const path=location.href.match(/^(.*)[?$]/)[1];const sheetList=getSheetList();createParams.resource=sheetList.filter(s=>!s.error).map(sheet=>({sheetId:sheet.sheetId,ranges:sheet.ranges,pageId:sheet.pageId,range:sheet.range}))const url=encodeURI(path+"?"+JSON.stringify(createParams));box_url.innerText="リンク";box_url.href=url;box_url.disabled=undefined;box_url.style.color="#000000"}else if(obj.id=="input_range"){getById("button_createUrl").disabled=true;box_url.style.color="#999999"}else if(obj.id=="checkButton"){if(await range_check()){button_createUrl.disabled=undefined}else{button_createUrl.disabled=true}box_url.style.color="#999999"}else{const as=getById("create_random").checked?"":getById("input_correctAnswer").value;if(as==""){createParams.correctAnswer=null}else{const converted=toBinary(as);const encoded=btoa(converted);const encoded2=encoded.split("").map(v=>v+""+String.fromCharCode(Math.floor(Math.random()*26)+65)).join("");createParams.correctAnswer=encoded2}createParams.random_choice=getById("create_random").checked;createParams.limit_word_minLength=getById("limit_word_minLength").value;createParams.limit_word_maxLength=getById("limit_word_maxLength").value;createParams.limit_answer_minLength=getById("limit_answer_minLength").value;createParams.limit_answer_maxLength=getById("limit_answer_maxLength").value;createParams.limit_correctAnswer_minLength=getById("limit_correctAnswer_minLength").value;createParams.limit_correctAnswer_maxLength=getById("limit_correctAnswer_maxLength").value;createParams.kanji_level=getById("kanji_level").value;box_url.style.color="#999999";getById("input_correctAnswer").disabled=getById("create_random").checked}}function simplify(word){return wordNormalize(word.replace(/[ 　・～∼ー―\-!！\?？]/g,""))}function nextHint(){if(hintObj.length==0){if(wordMap.has(correctAnswer)){wordMap.get(correctAnswer).forEach(o=>{const hint=o.tag1+"の"+o.tag2+(o.tag3?"("+o.tag3+")":"");const flags=hint.split("").map((v,i)=>i);hintObj.push({res:true,hint:hint,flags:flags,out:flags.map(v=>"*")})})}}const hint=[];for(let o of hintObj){if(o.flags.length==0){hint.push(o.out.join(""))}else{const idx=o.flags.splice(Math.floor(Math.random()*o.flags.length),1)[0];o.out[idx]=o.hint[idx];hint.push(o.out.join(""));break}}getById("hintBox").innerHTML=hint.join("<br>")}function onclick_rnd_choice(){getById("rndtxt").style.color=getById("rnd_choice").checked?"#000000":"#999999"}function determine(_txt,update=true){const txt=_txt?_txt:getById("inputBox").value;if(txt!=correctAnswer&&(txt.length<params.limit_answer_minLength||params.limit_answer_maxLength<txt.length)){alert(params.limit_answer_minLength+"～"+params.limit_answer_maxLength+"文字の範囲で入力してください","");return}const rn=getById("words").rows.length;const row=getById("words").insertRow(rn);const simpleWord=simplify(txt);if(simpleWordSet.has(simpleWord)||txt==correctAnswer){const nTxt=wordNormalize(txt);const sAns=correctAnswer.split("");const clsAry=[];for(let i in txt){if(i<correctAnswer.length&&txt[i]==correctAnswer[i]){clsAry.push("correct");sAns[i]="\0"}else{clsAry.push("none")}}for(let i in txt){if(clsAry[i]=="none"){const idx=sAns.indexOf(txt[i]);if(idx!=-1){clsAry[i]="neighbor";sAns[idx]="\0"}}}const nAns=sAns.map(wordNormalize);for(let i in txt){const cell=row.insertCell();if(clsAry[i]!="none"){cell.classList.add(clsAry[i])}else{const idx=nAns.indexOf(nTxt[i]);if(idx!=-1){cell.classList.add("neighbor");nAns[idx]="\0"}else{cell.classList.add("none")}}cell.innerText=txt[i];cell.colSpan=1}row.insertCell();if(txt.length>=tableWidth){let str="";tableCols.innerHTML="";for(let i=0;i<txt.length;i++){str+="<col style='width: 10px;'>"}tableCols.innerHTML=str+"<col border='1'>";tableWidth=txt.length+1;cellList.forEach(c=>c.colSpan=tableWidth)}if(txt==correctAnswer){getById("determineButton").disabled=true;for(let i=0;i<row.cells.length-1;i++){if(row.cells[i]){row.cells[i].style.border="solid 3px red"}}}}else{const nTxt=wordNormalize(txt);const nAns=wordNormalize(correctAnswer).split("");let count_hit=0;let count_near=0;for(let i in nTxt){if(i<nAns.length&&nTxt[i]==nAns[i]){count_hit++;nAns[i]="\0"}}for(let i in nTxt){if(nAns[i]!="\0"){const idx=nAns.indexOf(nTxt[i]);if(idx!=-1){count_near++;nAns[idx]="\0"}}}const cell=row.insertCell();cell.innerHTML="<span class='bad'>"+txt+"</span>"+(count_hit||count_near?":"+(count_hit?"<span class='correct_icon'>●</span>×"+count_hit:"")+(count_near?"<span class='neighbor_icon'>●</span>×"+count_near:""):"");cell.colSpan=tableWidth;cellList.push(cell)}if(update){history.push(txt)}localStorage.setItem("history",JSON.stringify(history));return false}function cell2words(cell){const map={"(\\":"\0a","\\)":"\0b","（\\":"\0c","\\）":"\0d","\0a":"(","\0b":")","\0c":"（","\0d":"）"};return cell.replace(/\(\\|\\\)|（\\|\\）/g,m=>map[m]).split("\n").flatMap(s=>{if(s.startsWith("//")){return[s]}else{return s.split(/[，\n\r\t（）()]+/)}}).map(v=>v.replace(/\0a|\0b|\0c|\0d/g,m=>map[m])).filter(v=>params.limit_word_minLength<=v.length&&v.length<=params.limit_word_maxLength)}function addWords(values){if(values.length==0||values[0].length==0){return}else if(values.length==1){values[0].forEach(cell=>cell2words(cell).forEach(v=>{if(!wordMap.has(v)){wordMap.set(v,[])}}))}else if(values[0].length==1){values.forEach(row=>cell2words(row[0]).forEach(v=>{if(!wordMap.has(v)){wordMap.set(v,[])}}))}else{for(let i=1;i<values.length;i++){const tag1=values[i][0];for(let j=1;j<values[i].length;j++){const tag2=values[0][j];const words=cell2words(values[i][j]);let tag3="";words.forEach(v=>{const tags={tag1:tag1,tag2:tag2,tag3:tag3.length>0?tag3:undefined};if(v.startsWith("//")){tag3=v.slice(2).trim()}else if(wordMap.has(v)){wordMap.get(v).push(tags)}else{wordMap.set(v,[tags]);simpleWordSet.add(simplify(v))}})}}}}async function initialize(reset=false){const wordTable=getById("words");while(wordTable.rows[0]){wordTable.deleteRow(0)}if(reset){history.length=0;localStorage.setItem("history",JSON.stringify(history))}else{history.forEach(word=>determine(word,false))}if(!reset&&(correctAnswer=localStorage.getItem("correctAnswer"))){}else if(correctAnswer=params.correctAnswer){}else if(params.random_choice){const kanji_regex=params.kanji_level==0?/([\u{3005}\u{3007}\u{303b}\u{3400}-\u{9FFF}\u{F900}-\u{FAFF}\u{20000}-\u{2FFFF}][\u{E0100}-\u{E01EF}\u{FE00}-\u{FE02}]?)/mu:params.kanji_level==1?/^([\u{3005}\u{3007}\u{303b}\u{3400}-\u{9FFF}\u{F900}-\u{FAFF}\u{20000}-\u{2FFFF}][\u{E0100}-\u{E01EF}\u{FE00}-\u{FE02}]?|[ 　])+$/mu:/^$/;const words=Array.from(wordMap.keys()).filter(word=>{const l=word.length;if(l<params.limit_correctAnswer_minLength||params.limit_correctAnswer_maxLength<l){return false}else{return!kanji_regex.test(word)}});correctAnswer=words[Math.floor(words.length*Math.random())]}else{const sheet=Sheet.get("1mUVGOxryU1d2C24iWAcixa2rgZeN_ZsdXHal_wOEQtE，シート1!A1:B");const range=(await sheet.getFormattedRangeList())[0];const req="https://sheets.googleapis.com/v4/spreadsheets/"+sheet.sheetId+"/values/"+range+"?key="+aKey;const res=await fetch(req,{method:"get"});if(res.ok){const data=JSON.parse(await res.text()).values;const today=new Date();for(let i=0;i<data.length;i++){if(data[i][0]!=""&&data[i][1]!=""){const day=new Date(data[i][0]);if(day>today){break}correctAnswer=data[i][1]}}}}localStorage.setItem("correctAnswer",correctAnswer);hintObj.length=0;getById("inputBox").value="";getById("hintBox").innerHTML="";getById("determineButton").disabled=undefined}async function getSheetData(sheetId){const req="https://sheets.googleapis.com/v4/spreadsheets/"+sheetId+"?key="+aKey;const res=await fetch(req,{method:"get"});if(res.ok){return JSON.parse(await res.text())}else{return}}async function startup(){screenLock();wordMap.clear();if(params.resource){for(let obj of params.resource){if(obj.pageId){const data=await getSheetData(obj.sheetId);if(data){const sheet=data.sheets.find(s=>s.properties.sheetId==obj.pageId);if(sheet){const req="https://sheets.googleapis.com/v4/spreadsheets/"+obj.sheetId+"/values/"+sheet.properties.title+"!"+obj.range+"?key="+aKey;const res=await fetch(req,{method:"get"});if(res.ok){const data=JSON.parse(await res.text());addWords(data.values)}}}}else{const ranges=[];let sheetData;for(let range of obj.ranges){const m=/^(.+)!(.+):([a-zA-Z]?)([0-9]?)/.exec(range);if(m[3]!=""&&m[4]!=""){ranges.push(range)}else{if(!sheetData){sheetData=await getSheetData(obj.sheetId)}const sheet=sheetData.sheets.find(s=>s.properties.title==m[1]);if(sheet){const gp=sheet.properties.gridProperties;ranges.push(m[1]+"!"+m[2]+":"+(m[3]?m[3]:col2char(gp.columnCount))+(m[4]?m[4]:gp.rowCount))}}}const req="https://sheets.googleapis.com/v4/spreadsheets/"+obj.sheetId+"/values:batchGet?key="+aKey+"&ranges="+ranges.join("&ranges=");const res=await fetch(req,{method:"get"});if(res.ok){const data=JSON.parse(await res.text());data.valueRanges.forEach(obj=>addWords(obj.values))}}}}await initialize();console.log("startup");screenUnlock()}async function range_check(){getById("create_error").innerHTML="";const sheetList=getSheetList();const sheetIdList=sheetList.map(obj=>obj.sheetId)let msgList=[];for(let sheet of sheetList){if(sheet.error){msgList.push("「"+sheet.text+"」：解析不可")}else{const isReadable=await sheet.isReadable();if(isReadable){const rangeList=await sheet.getFormattedRangeList();const req="https://sheets.googleapis.com/v4/spreadsheets/"+sheet.sheetId+"/values:batchGet?key="+aKey+"&ranges="+rangeList.join("&ranges=");await fetch(req,{method:"get"}).then(res=>{if(res.status!=200){msgList.push("「"+sheet.sheetId+"」：一部不可")}}).catch(()=>{msgList.push("「"+sheet.sheetId+"」：一部不可")})}else{msgList.push("「"+sheet.sheetId+"」：利用不可")}}}if(msgList.length==0&&sheetList.length>0){return true}else{getById("create_error").innerHTML=msgList.join("<br>");return false}}function getSheetList(){const lines=getById("input_range").value.split("\n").filter(v=>v.length>0);const ret=[];for(let line of lines){const sheet=Sheet.get(line);if(sheet!=null){ret.push(sheet)}else{ret.push({text:line,error:true})}}return ret}function toBinary(string){const codeUnits=new Uint16Array(string.length);for(let i=0;i<codeUnits.length;i++){codeUnits[i]=string.charCodeAt(i)}return String.fromCharCode(...new Uint8Array(codeUnits.buffer))}function fromBinary(binary){const bytes=new Uint8Array(binary.length);for(let i=0;i<bytes.length;i++){bytes[i]=binary.charCodeAt(i)}return String.fromCharCode(...new Uint16Array(bytes.buffer))}function col2char(colNum){let num=colNum;const map="ZABCDEFGHIJKLMNOPQRSTUVWXY";let str="";while(num>1){const res=num%26;str=map[res]+""+str;num=Math.floor((num-1)/26)}if(num==1)str="A"+str;return str}function getById(tag){return document.getElementById(tag)}function wordNormalize(word){const map={ア:"あ",イ:"い",ウ:"う",エ:"え",オ:"お",ぁ:"あ",ぃ:"い",ぅ:"う",ぇ:"え",ぉ:"お",ァ:"あ",ィ:"い",ゥ:"う",ェ:"え",ォ:"お",カ:"か",キ:"き",ク:"く",ケ:"け",コ:"こ",が:"か",ぎ:"き",ぐ:"く",げ:"け",ご:"こ",ガ:"か",ギ:"き",グ:"く",ゲ:"け",ゴ:"こ",サ:"さ",シ:"し",ス:"す",セ:"せ",ソ:"そ",ざ:"さ",じ:"し",ず:"す",ぜ:"せ",ぞ:"そ",ザ:"さ",ジ:"し",ズ:"す",ゼ:"せ",ゾ:"そ",タ:"た",チ:"ち",ツ:"つ",テ:"て",ト:"と",だ:"た",ぢ:"ち",づ:"つ",で:"て",ど:"と",ダ:"た",ヂ:"ち",ヅ:"つ",デ:"て",ド:"と",っ:"つ",ッ:"つ",ナ:"な",ニ:"に",ヌ:"ぬ",ネ:"ね",ノ:"の",ハ:"は",ヒ:"ひ",フ:"ふ",ヘ:"へ",ホ:"ほ",ば:"は",び:"ひ",ぶ:"ふ",べ:"へ",ぼ:"ほ",バ:"は",ビ:"ひ",ブ:"ふ",ベ:"へ",ボ:"ほ",ぱ:"は",ぴ:"ひ",ぷ:"ふ",ぺ:"へ",ぽ:"ほ",パ:"は",ピ:"ひ",プ:"ふ",ペ:"へ",ポ:"ほ",マ:"ま",ミ:"み",ム:"む",メ:"め",モ:"も",ゃ:"や",ゅ:"ゆ",ょ:"よ",ヤ:"や",ユ:"ゆ",ヨ:"よ",ャ:"や",ュ:"ゆ",ョ:"よ",ラ:"ら",リ:"り",ル:"る",レ:"れ",ロ:"ろ",ワ:"わ",ヲ:"を",ン:"ん",a:"A",b:"B",c:"C",d:"D",e:"E",f:"F",g:"G",h:"H",i:"I",j:"J",k:"K",l:"L",m:"M",n:"N",o:"O",p:"P",q:"Q",r:"R",s:"S",t:"T",u:"U",v:"V",w:"W",x:"X",y:"Y",z:"Z",Ａ:"A",Ｂ:"B",Ｃ:"C",Ｄ:"D",Ｅ:"E",Ｆ:"F",Ｇ:"G",ａ:"A",ｂ:"B",ｃ:"C",ｄ:"D",ｅ:"E",ｆ:"F",ｇ:"G",Ｈ:"H",Ｉ:"I",Ｊ:"J",Ｋ:"K",Ｌ:"L",Ｍ:"M",Ｎ:"N",ｈ:"H",ｉ:"I",ｊ:"J",ｋ:"K",ｌ:"L",ｍ:"M",ｎ:"N",Ｏ:"O",Ｐ:"P",Ｑ:"Q",Ｒ:"R",Ｓ:"S",Ｔ:"T",Ｕ:"U",ｏ:"O",ｐ:"P",ｑ:"Q",ｒ:"R",ｓ:"S",ｔ:"T",ｕ:"U",Ｖ:"V",Ｗ:"W",Ｘ:"X",Ｙ:"Y",Ｚ:"Z",ｖ:"V",ｗ:"W",ｘ:"X",ｙ:"Y",ｚ:"Z","０":"0","１":"1","２":"2","３":"3","４":"4","５":"5","６":"6","７":"7","８":"8","９":"9","．":".",ー:"-"};return word.split("").map(c=>map[c]?map[c]:c).join("")}function screenLock(){const element=document.createElement('div');element.id="screenLock";element.style.top='0px';element.style.left='0px';element.style.height='100%';element.style.width='100%';element.style.position='fixed';element.style.zIndex='9999';element.style.opacity='0';document.body.appendChild(element)}function screenUnlock(){const dom_obj=document.getElementById("screenLock");const dom_obj_parent=dom_obj.parentNode;dom_obj_parent.removeChild(dom_obj)}class Sheet{line;constructor(line){this.line=line.trim()}async isReadable(){const req="https://sheets.googleapis.com/v4/spreadsheets/"+this.sheetId+"?key="+aKey;let ret;await fetch(req,{method:"get"}).then(res=>ret=res.status==200).catch(()=>ret=false);return ret}async getSheetData(){const req="https://sheets.googleapis.com/v4/spreadsheets/"+this.sheetId+"?key="+aKey;const res=await fetch(req,{method:"get"});if(res.ok){return JSON.parse(await res.text())}else{return}}getRangeList(){if(this.pageId){return[this.pageId+"!"+this.range]}else{return this.ranges}}async getFormattedRangeList(){const sheetData=await this.getSheetData();if(this.pageId){if(sheetData){const pageId=this.pageId;const sheet=sheetData.sheets.find(s=>s.properties.sheetId==pageId);if(sheet){return[sheet.properties.title+"!"+this.range]}else{return}}else{return}}else{const ranges=[];for(let range of this.ranges){const m=/^(.+)!(.+):([a-zA-Z]?)([0-9]?)/.exec(range);if(m[3]!=""&&m[4]!=""){ranges.push(range)}else{const sheet=sheetData.sheets.find(s=>s.properties.title==m[1]);if(sheet){const gp=sheet.properties.gridProperties;ranges.push(m[1]+"!"+m[2]+":"+(m[3]?m[3]:col2char(gp.columnCount))+(m[4]?m[4]:gp.rowCount))}}}return ranges}}static get(line){const obj=new Sheet(line);const m1=obj.line.match(/https:\/\/docs.google.com\/spreadsheets\/d\/([0-9a-zA-Z_\-]+)/);if(m1!=null){const m2=obj.line.match(/gid=(\d+)/);const m3=obj.line.match(/range=([0-9a-zA-Z]+)(:[0-9a-zA-Z]*)?/);if(m2!=null&&m3!=null){obj.sheetId=m1[1];obj.pageId=m2[1]obj.range=m3[1]+(m3[2]?m3[2]:"");return obj}else{return null}}else{const values=obj.line.split(/[,，、]+/);obj.sheetId=values[0].trim();obj.ranges=values.slice(1).filter(str=>/.+![0-9a-zA-Z]+:[0-9a-zA-Z]*/.test(str)).map(str=>str.trim());if(/[0-9a-zA-Z_\-]{44}/.test(obj.sheetId)&&obj.ranges.length>0){return obj}else{return null}}}}</script></body></html>
